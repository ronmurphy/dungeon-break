<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gilded Depths</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Special+Elite&display=swap"
        rel="stylesheet">
    <link href="style.css?v=2" rel="stylesheet">



    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/23.1.2/tween.umd.js"></script>
</head>

<body>
    <div class="sidebar">
        <div class="title-area">
            <img src="assets/images/logo.png" alt="Gilded Depths" style="width: 50%; height: auto; filter: drop-shadow(0 2px 4px #000);">
        </div>

        <div class="stat-block" id="sidebarStats" style="display: block;">
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div style="flex-grow: 1;">
                    <div class="stat-label">Protagonist Vitality</div>
                    <div class="stat-value" id="hpValueSidebar">20</div>
                </div>
                <div style="text-align: right;">
                    <div class="stat-label">Floor</div>
                    <div class="stat-value" id="floorValue">1</div>
                </div>
            </div>
            <div class="health-bar" style="margin-top: 5px;">
                <div class="health-fill" id="hpBarSidebar" style="width: 100%"></div>
            </div>
            <div
                style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem; opacity: 0.8;">
                <div>Cleared: <span id="progressValue" style="color: var(--gold);">0 / 12</span></div>
                <div>Deck: <span id="deckValue" style="color: var(--gold);">44</span></div>
            </div>
        </div>

        <div class="stat-block" id="equippedWeaponSlot">
            <div class="stat-label">Main Armament</div>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                <div id="weaponArtSidebar"
                    style="width: 64px; height: 64px; background-size: cover; border: 1px solid var(--gold);"></div>
                <div>
                    <div id="weaponNameSidebar" style="font-weight: 700; color: var(--gold);">UNARMED</div>
                    <div id="weaponDurSidebar" style="font-size: 0.8rem; opacity: 0.7;">No limit</div>
                </div>
            </div>
        </div>

        <div class="log-container" id="gameLog">
            Welcome to the dungeon, traveler. Watch your step on the tiles.
        </div>

        <div style="margin-top: 15px; display: flex; flex-direction: column; gap:10px;">
            <button class="v2-btn" id="newGameBtn" style="width: 100%">NEW DIVE</button>
            <button class="v2-btn" id="viewToggleBtn" style="width: 100%; background:#444; color:#fff;">VIEW:
                3D</button>
        </div>
    </div>

    <div class="map-viewport" id="v3-container">
        <!-- Three.js renderer will be injected here -->
    </div>

    <!-- Gameplay Options Button (Top Left) -->
    <button id="gameplayOptionsBtn" class="v2-btn" title="Options" style="position:fixed; top:20px; left:20px; width:40px; height:40px; padding:0; display:flex; align-items:center; justify-content:center; z-index:9005; box-shadow:0 0 10px #000;">
        ⚙
    </button>
    
    <!-- Gameplay Inventory Bar (Bottom Center) -->
    <div id="gameplayInventoryBar" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:none; align-items:center; gap:10px; z-index:9005; background:rgba(0,0,0,0.85); padding:8px 15px; border:2px solid var(--gold); border-radius:30px; box-shadow:0 0 15px #000;">
        <!-- Equipped Weapon -->
        <div id="mapWeaponBtn" title="Inventory" style="width:48px; height:48px; border:1px solid #666; cursor:pointer; background-size:cover; background-position:center; position:relative;">
            <!-- Durability indicator gets injected here -->
        </div>
        
        <!-- Fuel Bar (Vertical Meter) -->
        <div class="fuel-meter-container" style="width:12px; height:36px; background:#111; border:1px solid #444; position:relative; margin:0 5px; box-shadow:inset 0 0 4px #000;" title="Torch Fuel">
            <div id="mapFuelBar" style="position:absolute; bottom:0; left:0; width:100%; background:linear-gradient(to top, #ff4400, #ffaa44); height:50%; transition:height 0.3s;"></div>
        </div>

        <!-- Hotbar Slots in Map View -->
        <div id="mapHotbar" style="display:flex; gap:6px;">
            <!-- Injected by JS -->
        </div>
    </div>
    
    <!-- Attraction Overlay (Start Screen) -->
    <div id="attractionOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9000; cursor:pointer; display:none;">
        <div style="position:absolute; bottom:10%; width:100%; text-align:center; color:#fff; font-family:'Cinzel'; font-size:1.5rem; text-shadow:0 0 10px #000; animation: pulse 2s infinite;">
            Click or Tap to Start...
        </div>
        <!-- Options Button moved to global gameplayOptionsBtn -->
    </div>

    <!-- Start Menu Modal -->
    <div id="startMenuModal" class="modal-overlay" style="display:none; z-index:9100;">
         <div class="dash-panel" style="width:300px; text-align:center; gap:20px; padding:30px; border: 2px solid var(--gold); background: rgba(0,0,0,0.9);">
             <img src="assets/images/logo.png" style="width:100%; margin-bottom:20px; filter: drop-shadow(0 0 10px var(--gold));">
             <button class="v2-btn" id="startNewDiveBtn" style="width:100%; margin-bottom:10px;">NEW DIVE</button>
             <button class="v2-btn" id="continueDiveBtn" style="width:100%; display:none;">CONTINUE</button>
             <button class="v2-btn" onclick="document.getElementById('startMenuModal').style.display='none'" style="width: 100%; margin-top: 10px; background: #444;">Back</button>
         </div>
    </div>

    <canvas id="fxCanvas"
        style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5000;"></canvas>
    <!-- UI FX Canvas: renders textured projectiles and particles above the modal UI -->
    <canvas id="uiFxCanvas"
        style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:99980;"></canvas>

    <!-- Avatar Selection Modal -->
    <div class="avatar-modal" id="avatarModal" style="display: none;">
        <div style="text-align: center;">
            <h2
                style="font-family: 'Cinzel', serif; color: var(--gold); font-size: 3rem; margin-bottom: 40px; text-shadow: 0 0 20px #000;">
                Choose Your Avatar</h2>
            <div class="avatar-options">
                <div class="avatar-card" onclick="selectAvatar('m')">
                    <div class="avatar-img" style="background-image: url('assets/images/rest_m_large.png')"></div>
                </div>
                <div class="avatar-card" onclick="selectAvatar('f')">
                    <div class="avatar-img" style="background-image: url('assets/images/rest_f_large.png')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Encounter Modal -->
    <div class="modal-overlay" id="combatModal">

        <div class="combat-container" id="combatContainer">
            <div class="enemy-area" id="enemyArea">
                <!-- Cards inject here -->
            </div>

            <!-- New "Compact Dashboard" Layout -->
            <div class="dashboard-wrapper">
                
                <!-- Left Panel: Hero Plate (Stats + Action) -->
                <div class="dash-panel hero-plate">
                    <!-- Top: HP & Status -->
                    <div class="vitality-row">
                        <div style="text-align:right;">
                            <div class="hp-big" id="hpValueModal">20</div>
                            <div class="hp-label-small">Vitality</div>
                        </div>
                        <div style="flex-grow:1;">
                            <div class="hp-bar-compact">
                                <div class="hp-fill-compact" id="hpBarModal"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:2px;">
                                <div class="hp-label-small"><span id="combatMessage" style="text-transform:none; color:#ddd; font-style:italic;">Make your move...</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle: Weapon & Meta Data -->
                    <div class="hero-info-grid">
                        <!-- Weapon Block -->
                        <div class="weapon-box">
                            <div id="weaponArtModal" class="weapon-icon-sq" style="background-image:none;"></div>
                            <div class="weapon-details">
                                <div id="weaponLastDealModal" class="durability-text">Durability: ∞</div>
                                <div class="soul-coins-text"><span id="soulCoinsValueModal">0</span> Coins</div>
                            </div>
                        </div>

                        <!-- Fuel Gauge (Vertical) -->
                        <div class="fuel-gauge-container" title="Torch Fuel">
                            <div class="fuel-fill" id="torchFuelBar" style="height: 50%;"></div>
                            <div class="fuel-label">FUEL</div>
                        </div>

                        <!-- Meta Info (Right aligned) -->
                        <div class="meta-box">
                            <div class="meta-row">Floor <span class="meta-val" id="floorValueModal">1</span></div>
                            <div class="meta-row">Deck <span class="meta-val" id="deckValueModal">44</span></div>
                            <div class="meta-row">Cleared <span class="meta-val" id="progressValueModal">0/12</span></div>
                        </div>
                    </div>

                    <!-- Bottom: Action Buttons -->
                    <div class="hero-actions">
                        <button class="btn-compact" id="modalAvoidBtn" disabled>Retreat</button>
                        <button class="btn-compact" id="exitCombatBtn" style="display:none;">Continue</button>
                        <button class="btn-compact btn-descend" id="descendBtn" style="display:none;">Descend Stairs</button>
                    </div>
                </div>

                <!-- Right Panel: Loot Locker -->
                <div class="dash-panel loot-locker">
                    <div class="loot-header">PROVISIONING & SPOILS</div>
                    <div class="loot-flex">
                        <!-- Inventory Slots -->
                        <div id="combatInventory" class="combat-inventory-grid">
                            <!-- Injected by JS -->
                        </div>
                        
                        <div class="vertical-divider"></div>

                        <!-- Trophy Shelf -->
                        <div class="trophy-container" id="trophyShelf">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>

            </div>
            <!-- End Dashboard Wrapper -->

        </div>
    </div>
    </div>
    <!-- Bonfire UI -->
    <div id="bonfireUI"
        style="display:none; flex-direction:column; align-items:center; justify-content:center; width:calc(100% - 320px); height:100%; text-align:center;">
        <h2
            style="font-family:'Cinzel'; font-size:3rem; color:#ff6600; text-shadow:0 0 20px #ff4400; margin-bottom:10px;">
            BONFIRE LIT</h2>

        <!-- HP Display added for reference -->
        <div style="font-size:1.5rem; color:#fff; font-family:'Crimson Text', serif; margin-bottom:20px;">
            Current HP: <span id="bonfireHpDisplay" style="color:#d4af37; font-weight:bold;">--</span> / <span id="bonfireMaxHpDisplay" style="color:#888;">--</span>
        </div>

        <!-- Avatar Rest Image -->
        <div id="bonfireImage"
            style="width:200px; height:300px; background-size:cover; background-position:center; border:4px solid #444; margin-bottom:20px; box-shadow:0 0 30px #ff4400;">
        </div>

        <div style="font-style:italic; margin-bottom:40px; color:#aaa;" id="bonfireStatus">Respite available.</div>
        <div style="display:flex; flex-direction:column; gap:20px; width:300px; margin:0 auto;">
            <button class="v2-btn" onclick="handleBonfire(1)" id="btnRest1">Light Rest (+5 HP) <span
                    style="font-size:0.8em; opacity:0.7;">(1 cost)</span></button>
            <button class="v2-btn" onclick="handleBonfire(2)" id="btnRest2">Deep Rest (+10 HP) <span
                    style="font-size:0.8em; opacity:0.7;">(2 costs)</span></button>
            <button class="v2-btn" onclick="handleBonfire(3)" id="btnRest3">Full Sleep (+15 HP) <span
                    style="font-size:0.8em; opacity:0.7;">(3 costs)</span></button>
            <button class="v2-btn" id="bonfireNotNowBtn"
                style="background:#555; color:#fff; margin-top:20px;">Leave</button>
        </div>
    </div>
    </div>

    <script type="module" src="scoundrel-3d.js"></script>
</body>

</html>